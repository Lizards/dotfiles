#!/bin/bash
# Suppress single quote warning:
# shellcheck disable=SC2016

X11_OPTS=(
    --device /dev/dri
    -e DISPLAY
    -v /tmp/.X11-unix:/tmp/.X11-unix:ro
)

X11_OPTS_COOKIE=(
    "${X11_OPTS[@]}"
    -e "XCOOKIE=$(xauth list | grep unix | cut -f2 -d'/' | tr -cd '\11\12\15\40-\176' | sed -e 's/  / /g')"
)

SOUND_OPTS=(
#    --device /dev/snd
#    --group-add $(getent group audio | cut -d: -f3)
    -e "PULSE_SERVER=unix:${XDG_RUNTIME_DIR}/pulse/native"
    -v "${XDG_RUNTIME_DIR}/pulse/native:${XDG_RUNTIME_DIR}/pulse/native:ro"
)

DBUS_OPTS=(
    -v /run/dbus:/run/dbus:ro
    -v "${XDG_RUNTIME_DIR}/bus:${XDG_RUNTIME_DIR}/bus:ro"
    -e DBUS_SESSION_BUS_ADDRESS
)

XDG_OPEN_SERVER_OPTS=(
    -e "UID=$(id --user)"
    -v "${XDG_RUNTIME_DIR}/xdg-open-server:${XDG_RUNTIME_DIR}/xdg-open-server:ro"
)

GTK_OPTS=(
    -v /usr/share/themes/:/usr/share/themes/
    -v "${HOME}/.gtkrc-2.0:/home/USER/.gtkrc-2.0"
)

function docker-cleanup {
    # Remove stopped containers
    docker ps -aq --no-trunc | xargs docker rm
    # Remove dangling/untagged images
    docker images -q --filter dangling=true | xargs docker rmi
}

function docker-ip {
    docker inspect --format '{{ .NetworkSettings.IPAddress }}' "${1}"
}

function docker-connect {
    dependencies "${1}"
    docker exec -it "${1}" "/bin/bash"
}

function dependencies {
    for container in "$@"; do
        local state
        state=$(docker inspect --format "{{.State.Running}}" "$container" 2>/dev/null)

        if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
            echo "$container is not running, starting it for you."
            $container
        fi
    done
}

function spotify {
    local OPTS=("$*")
    if [ "${OPTS[*]}" = "" ]; then
        OPTS=(--rm --detach)
    fi
    local name="spotify"
    echo -e "Launching spotify container"
    mkdir -p "${HOME}/.spotify/.config"
    mkdir -p "${HOME}/.spotify/.cache"
    set -x
    docker run "${OPTS[@]}" --name $name \
        -v /etc/localtime:/etc/localtime:ro \
        "${X11_OPTS_COOKIE[@]}" \
        "${SOUND_OPTS[@]}" \
        "${DBUS_OPTS[@]}" \
        -v "${HOME}/.spotify/.config:/home/spotify/.config" \
        -v "${HOME}/.spotify/.cache:/home/spotify/.cache" \
        --entrypoint "/bin/bash" \
        lizards/spotify \
        -c 'touch ~/.Xauthority && xauth add $XCOOKIE && spotify --force-device-scale-factor=2.0'
    set +x
}

function redis {
    local name='redis-3.2'
    if [ "${1}" == "stop" ]; then
        docker stop $name
    else
        echo -e "Launching Redis container"
        docker run --rm --detach --name $name \
            redis:3.2
    fi
}

function mysql-server {
    local name='mysql-server'
    if [ "${1}" == "stop" ]; then
        docker stop $name
    else
        echo -e "Launching MySQL container"
        docker run --rm --detach --name $name \
            -v "${HOME}/work/mysql-data:/var/lib/mysql" \
            -v "${HOME}/work/mysql-dumps:/mysql-dumps" \
            -e MYSQL_ROOT_PASSWORD=root \
            -e MYSQL_ROOT_HOST=172.17.0.1 \
            mysql/mysql-server:5.7.20
    fi
}

function mysql-workbench {
    dependencies mysql-server
    mkdir -p "${HOME}/.mysql-workbench/workbench"
    mkdir -p "${HOME}/.mysql-workbench/workspace"
    local name='mysql-workbench'
    local user='developer'
    echo -e "Launching MySQL workbench"
    docker run --rm --detach --name $name \
        "${X11_OPTS_COOKIE[@]}" \
        "${DBUS_OPTS[@]}" \
        "${GTK_OPTS[@]//USER/$user}" \
        -v "${HOME}/.mysql-workbench/workbench:/home/${user}/.mysql/workbench" \
        -v "${HOME}/.mysql-workbench/workspace:/home/${user}/workspace" \
        --link mysql-server \
        openkbs/mysql-workbench \
        /bin/bash -c "touch /home/${user}/.Xauthority && xauth add \$XCOOKIE && mysql-workbench"
}

function memcached {
    local name='memcached-1.4.36'
    if [ "${1}" == "stop" ]; then
        docker stop $name
    else
        echo -e "Launching Memcached"
        docker run --rm --detach --name $name \
        memcached:1.4.36-alpine
    fi
}

function vlc {
    local OPTS=("$*")
    if [ "${OPTS[*]}" = "" ]; then
        OPTS=(--rm --detach)
    fi
    local name="vlc"
    echo -e "Launching VLC container"
    mkdir -p "${HOME}/.vlc/.config"
    docker run "${OPTS[@]}" --name $name \
        -v /etc/localtime:/etc/localtime:ro \
        "${X11_OPTS_COOKIE[@]}" \
        "${SOUND_OPTS[@]}" \
        "${DBUS_OPTS[@]}" \
        -v "${HOME}/.vlc/.config:/home/vlc/.config" \
        -v "${HOME}:/media:ro" \
        --entrypoint "/bin/bash" \
        lizards/vlc \
        -c 'touch ~/.Xauthority && xauth add $XCOOKIE && vlc'
}

function filezilla {
    local name='filezilla'
    local user='filezilla'
    local OPTS=("$*")
    if [ "${OPTS[*]}" = "" ]; then
        OPTS=(--rm --detach)
    fi
    echo -e "Launching Filezilla container"
    mkdir -p "${HOME}/.filezilla"
    docker run "${OPTS[@]}" --name $name \
        -v /etc/localtime:/etc/localtime:ro \
        "${DBUS_OPTS[@]}" \
        "${X11_OPTS_COOKIE[@]}" \
        "${XDG_OPEN_SERVER_OPTS[@]}" \
        "${GTK_OPTS[@]//USER/$user}" \
        -v "${HOME}/.filezilla:/home/${user}/.config/filezilla" \
        -v "${HOME}:/host" \
        lizards/filezilla
}

function rutorrent {
    local name='rutorrent'
    local OPTS=("$*")
    if [ "${1}" = "stop" ]; then
        docker stop $name
    else
        if [ "${OPTS[*]}" = "" ]; then
            OPTS=(--rm --detach)
        fi
        echo -e "Launching ${name} container"
        mkdir -p "${HOME}/.rutorrent/config"
        mkdir -p "${HOME}/.rutorrent/downloads"
        docker run "${OPTS[@]}" --name=$name \
            -v "${HOME}/.rutorrent/config:/config" \
            -v "${HOME}/.rutorrent/downloads:/downloads" \
            -e PGID="$(id --group)" \
            -e PUID="$(id --user)" \
            -e TZ="$(timedatectl | grep "Time zone" | awk '{print $3}')" \
            -p 8080:80 \
            -p 5000:5000 \
            -p 51413:51413 \
            -p 6881:6881/udp \
            linuxserver/rutorrent
    fi
}

function shellcheck {
    for file in "$@"; do
        file=$(realpath $file)
        docker run --rm \
            -v "${file}:/${file}:ro" \
            koalaman/shellcheck \
            -x "${file}"
    done
}
