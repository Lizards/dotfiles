#!/bin/bash

X11_OPTS=(
    --device /dev/dri
    -e DISPLAY=unix$DISPLAY
    -v /tmp/.X11-unix:/tmp/.X11-unix:ro
)

X11_OPTS_COOKIE=(
    "${X11_OPTS[@]}"
    -e XCOOKIE="$(xauth list | grep unix | cut -f2 -d'/' | tr -cd '\11\12\15\40-\176' | sed -e 's/  / /g')"
)

SOUND_OPTS=(
#    --device /dev/snd
#    --group-add $(getent group audio | cut -d: -f3)
    -e PULSE_SERVER=unix:$XDG_RUNTIME_DIR/pulse/native
    -v $XDG_RUNTIME_DIR/pulse/native:$XDG_RUNTIME_DIR/pulse/native:ro
)

DBUS_OPTS=(
    -v /run/dbus:/run/dbus:ro
    -v $XDG_RUNTIME_DIR/bus:$XDG_RUNTIME_DIR/bus:ro
    -e DBUS_SESSION_BUS_ADDRESS
)

function dependencies {
    for container in "$@"; do
        local state
        state=$(docker inspect --format "{{.State.Running}}" "$container" 2>/dev/null)

        if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
            echo "$container is not running, starting it for you."
            $container
        fi
    done
}

function spotify {
    local name='spotify'
    echo -e "Launching spotify container" 
    docker run --rm --detach --name $name \
        "${X11_OPTS_COOKIE[@]}" \
        "${SOUND_OPTS[@]}" \
        "${DBUS_OPTS[@]}" \
        -v $HOME/.spotify/config:/home/user/.config/spotify \
        -v $HOME/.spotify/cache:/home/user/.cache/spotify \
        lizards/spotify \
        --force-device-scale-factor=1.5
}

function mariadb-server {
    local name='mariadb-server'
    if [ "${1}" == "stop" ]; then
        docker stop $name
    else
        echo -e "Launching MariaDB container"
        docker run --rm --detach --name $name \
            -v $HOME/work/mariadb-data:/var/lib/mysql \
            -v $HOME/work/mysql-dumps:/mysql-dumps \
            -e MYSQL_ROOT_PASSWORD=root \
            mariadb:10.1.22
    fi
}

function mysql-server {
    local name='mysql-server'
    if [ "${1}" == "stop" ]; then
        docker stop $name
    else
        echo -e "Launching MySQL container"
        docker run --rm --detach --name $name \
            -v $HOME/work/mysql-data:/var/lib/mysql \
            -v $HOME/work/mysql-dumps:/mysql-dumps \
            -e MYSQL_ROOT_PASSWORD=root \
            mysql/mysql-server:5.7.20
    fi
}

function mysql-workbench {
    dependencies mysql-server
    local name='mysql-workbench'
    echo -e "Launching MySQL workbench"
    docker run --rm --detach --name $name \
        "${X11_OPTS_COOKIE[@]}" \
        -v $HOME/.mysql-workbench/workbench:/home/developer/.mysql/workbench \
        -v $HOME/.mysql-workbench/workspace:/home/developer/workspace \
        --link mysql-server \
        openkbs/mysql-workbench \
        /bin/bash -c 'touch /home/developer/.Xauthority && xauth add $XCOOKIE && mysql-workbench'
}